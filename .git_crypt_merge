#!/bin/sh
if [ ! -r '.vault_pass' ]; then
  exit 1
fi

BASE=$1
CURRENT=$2
OTHER=$3
LOCATION=$4

set -e

ansible-vault decrypt $BASE --vault-password-file=.vault_pass > /dev/null
ansible-vault decrypt $CURRENT --vault-password-file=.vault_pass > /dev/null
ansible-vault decrypt $OTHER --vault-password-file=.vault_pass > /dev/null

if ! git merge-file -L CURRENT -L BASE -L OTHER $CURRENT $BASE $OTHER; then
  ansible-vault encrypt $CURRENT --vault-password-file=.vault_pass
  exit 1
else
  ansible-vault encrypt $CURRENT --vault-password-file=.vault_pass
fi
